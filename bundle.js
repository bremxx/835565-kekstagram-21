(()=>{"use strict";window.util={shuffle:function(e){let t,n;for(let o=e.length-1;o>0;o--)t=Math.floor(Math.random()*(o+1)),n=e[t],e[t]=e[o],e[o]=n;return e},modal:{show:function(e){e.classList.remove("hidden"),document.body.classList.add("modal-open")},hide:function(e){e.classList.add("hidden"),document.body.classList.remove("modal-open")}},element:{show:function(e){e.classList.remove("hidden")},hide:function(e){e.classList.add("hidden")}}},window.debounce=function(e){let t=null;return(...n)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...n)}),500)}},(()=>{const e=document.querySelector("#picture").content.querySelector(".picture");window.renderPicture=function(t){const n=e.cloneNode(!0);return n.querySelector(".picture__img").src=t.url,n.querySelector(".picture__likes").textContent=t.likes,n.querySelector(".picture__comments").textContent=t.comments.length,n}})(),(()=>{const e=document.querySelector(".big-picture"),t=e.querySelector(".big-picture__img img"),n=e.querySelector(".likes-count"),o=e.querySelector(".comments-count"),r=e.querySelector(".social__comments"),i=r.querySelector(".social__comment"),c=e.querySelector(".social__caption"),s=e.querySelector(".big-picture__cancel"),l=e.querySelector(".comments-loader");function u(e){const t=i.cloneNode(!0);return t.querySelector(".social__picture").src=e.avatar,t.querySelector(".social__picture").alt=e.name,t.querySelector(".social__text").textContent=e.message,t}function d(e){const t=document.createDocumentFragment();for(let n=0;n<e.length;n++)t.appendChild(u(e[n]));return r.appendChild(t)}function a(){v()}function f(e){"Escape"===e.key&&(e.preventDefault(),v())}function m(e){e.target.closest(".big-picture__preview")||v()}function v(){window.util.modal.hide(e),document.removeEventListener("keydown",f),e.removeEventListener("click",m),s.removeEventListener("click",a)}window.showBigPicture=function(i){window.util.modal.show(e),t.src=i.url,n.textContent=i.likes,o.textContent=i.comments.length,c.textContent=i.description,e.querySelector(".social__comment-count").classList.add("hidden"),function(e){r.innerHTML="";const t=e.length;let n=t>=5?5:t;function o(){const o=t-n,r=n+(o>=5?5:o);d(e.slice(n,r)),n=r,i()}function i(){t<=n?(window.util.element.hide(l),l.removeEventListener("click",o)):(window.util.element.show(l),l.addEventListener("click",o))}d(e.slice(0,n)),i()}(i.comments),document.addEventListener("keydown",f),e.addEventListener("click",m),s.addEventListener("click",a)}})(),(()=>{const e=["gif","jpg","jpeg","png"],t=document.querySelector(".img-upload__form"),n=t.querySelector(".img-upload__input"),o=document.querySelector(".img-upload__overlay"),r=o.querySelector(".img-upload__preview img"),i=o.querySelector(".img-upload__cancel"),c=o.querySelector(".img-upload__scale"),s=o.querySelector(".scale__control--smaller"),l=o.querySelector(".scale__control--value"),u=o.querySelector(".effects__list"),d={chrome:"grayscale",sepia:"sepia",marvin:"invert",phobos:"blur",heat:"brightness"},a=o.querySelector(".img-upload__effect-level"),f=a.querySelector(".effect-level__line"),m=a.querySelector(".effect-level__pin"),v=a.querySelector(".effect-level__value"),w=a.querySelector(".effect-level__depth"),p=o.querySelector(".text__hashtags"),y=/^#[a-zA-Zа-яА-Я\d]+$/,h=o.querySelector(".text__description");function L(){n.value="",r.style.transform="",r.style.width="",u.querySelector("#effect-none").checked=!0,w.style.width="",p.value="",h.value="",window.util.modal.hide(o),S(b()),document.removeEventListener("keydown",g),i.removeEventListener("click",_),c.removeEventListener("click",q),u.removeEventListener("change",k),m.removeEventListener("mousedown",x),p.removeEventListener("input",P),h.removeEventListener("focusin",V),h.removeEventListener("focusout",H),p.removeEventListener("focusin",V),p.removeEventListener("focusout",H),t.removeEventListener("submit",E)}function _(){L()}function g(e){"Escape"===e.key&&(e.preventDefault(),L())}function E(e){window.load.post(new FormData(t),(()=>{L(),window.showPopup("success")}),(()=>{L(),window.showPopup("error")})),e.preventDefault()}function q(e){const t=parseInt(l.value,10);let n;var o,i;n=e.target===s?(o=t)>25?o-25:o:function(e){return 100===e?e:e+25}(t),l.value=n+"%",i=n,r.style.transform=`scale(${i/100})`}function k(e){e.target.matches('input[type="radio"]')&&(C(e.target.value,100),m.style.left=Math.floor(100*f.offsetWidth/100)+"px")}function S(e){r.classList.remove(e),r.style.filter="",w.style.width="100%"}function b(){const e=r.classList;for(let t=0;t<e.length;t++)if(e[t].includes("effects__preview--"))return e[t];return null}function x(e){e.preventDefault();const t=f.offsetWidth;let n=e.clientX;function o(e){e.preventDefault();let o=(r=m.offsetLeft,Math.floor(100*r/f.offsetWidth));var r;v.value=o,C(u.querySelector('input[type="radio"]:checked').value,o);const i=n-e.clientX;n=e.clientX;let c=m.offsetLeft-i;var s;s=c>0&&c<t?c:c>0?t:0,m.style.left=s+"px",w.style.width=o+"%"}document.addEventListener("mousemove",o),document.addEventListener("mouseup",(function e(t){t.preventDefault(),document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",e)}))}function C(e,t){switch(function(e){const t=b();var n;t!=="effects__preview--"+e&&("none"!==e?(window.util.element.show(a),S(t),n=e,r.classList.add("effects__preview--"+n)):(window.util.element.hide(a),S(t)))}(e),e){case"phobos":r.style.filter=d[e]+`(${3*t/100}px)`;break;case"heat":r.style.filter=d[e]+`(${3*t/100})`;break;case"marvin":r.style.filter=d[e]+`(${t}%)`;break;default:r.style.filter=d[e]+`(${t/100})`}}function P(e){!function(e){let t=e.target.value.split(/ +/);for(let e=0;e<t.length;e++)y.test(t[e])||0===t[e].length?t[e].length>20?(p.setCustomValidity(`Хэштэг ${t[e]} слишком длинный!`),$(p)):t.length>5?(p.setCustomValidity("Слишком много хэштэгов!"),$(p)):D(t)?(p.setCustomValidity("Не используйте одинаковые хэштэги!"),$(p)):T(t)?(p.setCustomValidity("Не используйте пустые хэштэги!"),$(p)):(p.setCustomValidity(""),p.style.border="",p.style.padding=""):(p.setCustomValidity(`Неверный формат хэштэга ${t[e]} !`),$(p)),p.reportValidity();p.reportValidity()}(e)}function D(e){return e.some((t=>e.indexOf(t)!==e.lastIndexOf(t)))}function $(e){e.style.border="5px solid red",e.style.padding="2px 7px"}function T(e){for(let t=0;t<e.length;t++)if(1===e[t].length)return!0;return!1}function V(){document.removeEventListener("keydown",g)}function H(){document.addEventListener("keydown",g)}h.maxLength=140,window.form={setHandler:function(e){n.addEventListener("change",e)},open:function(){window.util.modal.show(o),null===b()&&window.util.element.hide(a),l.value="100%",c.addEventListener("click",q),i.addEventListener("click",_),document.addEventListener("keydown",g),u.addEventListener("change",k),m.addEventListener("mousedown",x),p.addEventListener("input",P),h.addEventListener("focusin",V),h.addEventListener("focusout",H),p.addEventListener("focusin",V),p.addEventListener("focusout",H),t.addEventListener("submit",E)},close:L,uploadPhoto:function(){const t=n.files[0],o=t.name.toLowerCase();if(e.some((function(e){return o.endsWith(e)}))){const e=new FileReader;e.addEventListener("load",(function(){r.src=e.result,r.style.width="100%"})),e.readAsDataURL(t)}}}})(),(()=>{const e="https://21.javascript.pages.academy/kekstagram";window.load={get:function(t,n){const o=new XMLHttpRequest;o.responseType="json",o.timeout=1e4,o.open("GET",e+"/data",!0),o.addEventListener("load",(function(){switch(o.status){case 200:t(o.response);break;case 400:n("Неверный запрос");break;case 401:n("Пользователь не авторизован");break;case 404:n("Ошибка загрузки данных");break;default:n("Cтатус ответа:"+(o.status+o.statusText))}})),o.addEventListener("error",(()=>{n("Произошла ошибка соединения")})),o.addEventListener("timeout",(()=>{n(`Запрос не успел выполниться за ${o.timeout/1e3} сек.`)})),o.send()},post:function(t,n,o){const r=new XMLHttpRequest;r.responseType="json",r.addEventListener("load",(function(){200===r.status?n():o()})),r.open("POST",e,!0),r.send(t)}}})(),(()=>{const e=document.querySelector(".img-filters"),t=e.querySelector(".img-filters__form");let n;window.filters={setHandler:function(o,r){t.addEventListener("click",(t=>{!function(t){const o="img-filters__button--active";n=e.querySelector("."+o),n.classList.remove(o),t.classList.add(o),n=t}(t.target);const i=function(e){const t=n.id,o=e.slice();switch(t){case"filter-random":return window.util.shuffle(o).slice(-10);case"filter-discussed":return o.sort(((e,t)=>t.comments.length-e.comments.length));default:return e}}(r);o(i)}))},show:function(){e.classList.remove("img-filters--inactive")}}})(),(()=>{const e=document.querySelector(".pictures");window.renderPhotos=function(t){const n=e.querySelectorAll(".picture");for(let e of n)e.parentNode.removeChild(e);const o=document.createDocumentFragment();for(let e=0;e<t.length;e++){let n=window.renderPicture(t[e],e);n.addEventListener("click",(()=>{window.showBigPicture(t[e])})),o.appendChild(n)}return e.appendChild(o)}})(),(()=>{const e=document.querySelector("main"),t=document.querySelector("#success").content.querySelector(".success").cloneNode(!0),n=t.querySelector(".success__button"),o=document.querySelector("#error").content.querySelector(".error").cloneNode(!0),r=o.querySelector(".error__button");let i;function c(t){e.insertAdjacentElement("afterbegin",t)}function s(e){e.remove(),e===t?(n.removeEventListener("click",l),document.removeEventListener("keydown",d),e.removeEventListener("click",a)):(r.removeEventListener("click",u),document.removeEventListener("keydown",d),e.removeEventListener("click",f))}function l(){s(t)}function u(){s(o)}function d(e){"Escape"===e.key&&(e.preventDefault(),s(i))}function a(e){e.target.closest(".success__inner")||s(t)}function f(e){e.target.closest(".error__inner")||s(o)}window.showPopup=function(e){return"success"===e?(i=t,c(i),n.addEventListener("click",l),document.addEventListener("keydown",d),i.addEventListener("click",a)):"error"===e?(i=o,c(i),r.addEventListener("click",u),document.addEventListener("keydown",d),i.addEventListener("click",f)):c(function(e){const t=document.createElement("div");return t.style="\n    z-index: 100;\n    position: fixed;\n    left: 0;\n    right: 0;\n    margin: 0 auto;\n    padding: 5px;\n    text-align: center;\n    background-color: #ff0000;\n    font-size: 18px;\n    font-weight: bold;",t.textContent=e,t}(e)),i}})(),window.load.get((function(e){window.renderPhotos(e),window.filters.show();const t=window.debounce((e=>window.renderPhotos(e)));window.filters.setHandler(t,e)}),(function(e){window.showPopup(e)})),window.form.setHandler((function(){window.form.open(),window.form.uploadPhoto()}))})();
(()=>{"use strict";window.util={shuffle:e=>{let t,n;for(let o=e.length-1;o>0;o--)t=Math.floor(Math.random()*(o+1)),n=e[t],e[t]=e[o],e[o]=n;return e},modal:{show:e=>{e.classList.remove("hidden"),document.body.classList.add("modal-open")},hide:e=>{e.classList.add("hidden"),document.body.classList.remove("modal-open")}},element:{show:e=>{e.classList.remove("hidden")},hide:e=>{e.classList.add("hidden")}}},window.debounce=e=>{let t=null;return(...n)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...n)}),500)}},(()=>{const e=document.querySelector("#picture").content.querySelector(".picture");window.renderPicture=t=>{const n=e.cloneNode(!0);return n.querySelector(".picture__img").src=t.url,n.querySelector(".picture__likes").textContent=t.likes,n.querySelector(".picture__comments").textContent=t.comments.length,n}})(),(()=>{const e=document.querySelector(".big-picture"),t=e.querySelector(".big-picture__img img"),n=e.querySelector(".likes-count"),o=e.querySelector(".comments-count"),r=e.querySelector(".social__comments"),s=r.querySelector(".social__comment"),i=e.querySelector(".social__caption"),c=e.querySelector(".big-picture__cancel"),l=e.querySelector(".comments-loader"),d=e=>{const t=s.cloneNode(!0);return t.querySelector(".social__picture").src=e.avatar,t.querySelector(".social__picture").alt=e.name,t.querySelector(".social__text").textContent=e.message,t},a=e=>{const t=document.createDocumentFragment();for(let n=0;n<e.length;n++)t.appendChild(d(e[n]));return r.appendChild(t)},u=()=>{w()},m=e=>{"Escape"===e.key&&(e.preventDefault(),w())},v=e=>{e.target.closest(".big-picture__preview")||w()},w=()=>{window.util.modal.hide(e),document.removeEventListener("keydown",m),e.removeEventListener("click",v),c.removeEventListener("click",u)};window.showBigPicture=s=>{window.util.modal.show(e),t.src=s.url,n.textContent=s.likes,o.textContent=s.comments.length,i.textContent=s.description,e.querySelector(".social__comment-count").classList.add("hidden"),(e=>{r.innerHTML="";const t=e.length;let n=t>=5?5:t;const o=()=>{const o=t-n,r=n+(o>=5?5:o);a(e.slice(n,r)),n=r,s()},s=()=>{t<=n?(window.util.element.hide(l),l.removeEventListener("click",o)):(window.util.element.show(l),l.addEventListener("click",o))};a(e.slice(0,n)),s()})(s.comments),document.addEventListener("keydown",m),e.addEventListener("click",v),c.addEventListener("click",u)}})(),(()=>{const e=["gif","jpg","jpeg","png"],t=document.querySelector(".img-upload__form"),n=t.querySelector(".img-upload__input"),o=document.querySelector(".img-upload__overlay"),r=o.querySelector(".img-upload__preview img"),s=o.querySelector(".img-upload__cancel"),i=o.querySelector(".img-upload__scale"),c=o.querySelector(".scale__control--smaller"),l=o.querySelector(".scale__control--value"),d=o.querySelector(".effects__list"),a={chrome:"grayscale",sepia:"sepia",marvin:"invert",phobos:"blur",heat:"brightness"},u=o.querySelector(".img-upload__effect-level"),m=u.querySelector(".effect-level__line"),v=u.querySelector(".effect-level__pin"),w=u.querySelector(".effect-level__value"),p=u.querySelector(".effect-level__depth"),f=o.querySelector(".text__hashtags"),y=/^#[a-zA-Zа-яА-Я\d]+$/,h=o.querySelector(".text__description");h.maxLength=140;const L=()=>{H()},_=e=>{"Escape"===e.key&&(e.preventDefault(),H())},g=e=>{window.load.post(new FormData(t),(()=>{H(),window.showPopup("success")}),(()=>{H(),window.showPopup("error")})),e.preventDefault()},E=e=>{const t=parseInt(l.value,10);let n;var o,s;n=e.target===c?(o=t)>25?o-25:o:(e=>100===e?e:e+25)(t),l.value=n+"%",s=n,r.style.transform=`scale(${s/100})`},q=()=>{const e=r.classList;for(let t=0;t<e.length;t++)if(e[t].includes("effects__preview--"))return e[t];return null},k=e=>{r.classList.remove(e),r.style.filter="",p.style.width="100%"},S=(e,t)=>{switch((e=>{const t=q();var n;t!=="effects__preview--"+e&&("none"!==e?(window.util.element.show(u),k(t),n=e,r.classList.add("effects__preview--"+n)):(window.util.element.hide(u),k(t)))})(e),e){case"phobos":r.style.filter=a[e]+`(${3*t/100}px)`;break;case"heat":r.style.filter=a[e]+`(${3*t/100})`;break;case"marvin":r.style.filter=a[e]+`(${t}%)`;break;default:r.style.filter=a[e]+`(${t/100})`}},b=e=>{if(e.target.matches('input[type="radio"]')){const t=e.target.value;S(t,100),v.style.left=Math.floor(100*m.offsetWidth/100)+"px"}},x=e=>{e.preventDefault();const t=m.offsetWidth;let n=e.clientX;const o=e=>{e.preventDefault();let o=(r=v.offsetLeft,Math.floor(100*r/m.offsetWidth));var r;w.value=o;const s=d.querySelector('input[type="radio"]:checked');S(s.value,o);const i=n-e.clientX;n=e.clientX;let c=v.offsetLeft-i;var l;l=c>0&&c<t?c:c>0?t:0,v.style.left=l+"px",p.style.width=o+"%"},r=e=>{e.preventDefault(),document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",r)};document.addEventListener("mousemove",o),document.addEventListener("mouseup",r)},C=e=>e.some((t=>e.indexOf(t)!==e.lastIndexOf(t))),P=e=>{e.style.border="5px solid red",e.style.padding="2px 7px"},D=e=>{for(let t=0;t<e.length;t++)if(1===e[t].length)return!0;return!1},$=e=>{(e=>{let t=e.target.value.split(/ +/);for(let e=0;e<t.length;e++)y.test(t[e])||0===t[e].length?t[e].length>20?(f.setCustomValidity(`Хэштэг ${t[e]} слишком длинный!`),P(f)):t.length>5?(f.setCustomValidity("Слишком много хэштэгов!"),P(f)):C(t)?(f.setCustomValidity("Не используйте одинаковые хэштэги!"),P(f)):D(t)?(f.setCustomValidity("Не используйте пустые хэштэги!"),P(f)):(f.setCustomValidity(""),f.style.border="",f.style.padding=""):(f.setCustomValidity(`Неверный формат хэштэга ${t[e]} !`),P(f)),f.reportValidity();f.reportValidity()})(e)},T=()=>{document.removeEventListener("keydown",_)},V=()=>{document.addEventListener("keydown",_)},H=()=>{n.value="",r.style.transform="",r.style.width="",d.querySelector("#effect-none").checked=!0,p.style.width="",f.value="",h.value="",window.util.modal.hide(o),k(q()),document.removeEventListener("keydown",_),s.removeEventListener("click",L),i.removeEventListener("click",E),d.removeEventListener("change",b),v.removeEventListener("mousedown",x),f.removeEventListener("input",$),h.removeEventListener("focusin",T),h.removeEventListener("focusout",V),f.removeEventListener("focusin",T),f.removeEventListener("focusout",V),t.removeEventListener("submit",g)};window.form={setHandler:e=>{n.addEventListener("change",e)},open:()=>{window.util.modal.show(o),null===q()&&window.util.element.hide(u),l.value="100%",i.addEventListener("click",E),s.addEventListener("click",L),document.addEventListener("keydown",_),d.addEventListener("change",b),v.addEventListener("mousedown",x),f.addEventListener("input",$),h.addEventListener("focusin",T),h.addEventListener("focusout",V),f.addEventListener("focusin",T),f.addEventListener("focusout",V),t.addEventListener("submit",g)},close:H,uploadPhoto:()=>{const t=n.files[0],o=t.name.toLowerCase();if(e.some((e=>o.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{r.src=e.result,r.style.width="100%"})),e.readAsDataURL(t)}}}})(),(()=>{const e="https://21.javascript.pages.academy/kekstagram";window.load={get:(t,n)=>{const o=new XMLHttpRequest;o.responseType="json",o.timeout=1e4,o.open("GET",e+"/data",!0),o.addEventListener("load",(()=>{switch(o.status){case 200:t(o.response);break;case 400:n("Неверный запрос");break;case 401:n("Пользователь не авторизован");break;case 404:n("Ошибка загрузки данных");break;default:n("Cтатус ответа:"+(o.status+o.statusText))}})),o.addEventListener("error",(()=>{n("Произошла ошибка соединения")})),o.addEventListener("timeout",(()=>{n(`Запрос не успел выполниться за ${o.timeout/1e3} сек.`)})),o.send()},post:(t,n,o)=>{const r=new XMLHttpRequest;r.responseType="json",r.addEventListener("load",(()=>{200===r.status?n():o()})),r.open("POST",e,!0),r.send(t)}}})(),(()=>{const e=document.querySelector(".img-filters"),t=e.querySelector(".img-filters__form");let n;window.filters={setHandler:(o,r)=>{t.addEventListener("click",(t=>{(t=>{const o="img-filters__button--active";n=e.querySelector("."+o),n.classList.remove(o),t.classList.add(o),n=t})(t.target);const s=(e=>{const t=n.id,o=e.slice();switch(t){case"filter-random":return window.util.shuffle(o).slice(-10);case"filter-discussed":return o.sort(((e,t)=>t.comments.length-e.comments.length));default:return e}})(r);o(s)}))},show:()=>{e.classList.remove("img-filters--inactive")}}})(),(()=>{const e=document.querySelector(".pictures");window.renderPhotos=t=>{const n=e.querySelectorAll(".picture");for(let e of n)e.parentNode.removeChild(e);const o=document.createDocumentFragment();for(let e=0;e<t.length;e++){let n=window.renderPicture(t[e],e);n.addEventListener("click",(()=>{window.showBigPicture(t[e])})),o.appendChild(n)}return e.appendChild(o)}})(),(()=>{const e=document.querySelector("main"),t=document.querySelector("#success").content.querySelector(".success").cloneNode(!0),n=t.querySelector(".success__button"),o=document.querySelector("#error").content.querySelector(".error").cloneNode(!0),r=o.querySelector(".error__button");let s;const i=t=>{e.insertAdjacentElement("afterbegin",t)},c=e=>{e.remove(),e===t?(n.removeEventListener("click",l),document.removeEventListener("keydown",a),e.removeEventListener("click",u)):(r.removeEventListener("click",d),document.removeEventListener("keydown",a),e.removeEventListener("click",m))},l=()=>{c(t)},d=()=>{c(o)},a=e=>{"Escape"===e.key&&(e.preventDefault(),c(s))},u=e=>{e.target.closest(".success__inner")||c(t)},m=e=>{e.target.closest(".error__inner")||c(o)};window.showPopup=e=>("success"===e?(s=t,i(s),n.addEventListener("click",l),document.addEventListener("keydown",a),s.addEventListener("click",u)):"error"===e?(s=o,i(s),r.addEventListener("click",d),document.addEventListener("keydown",a),s.addEventListener("click",m)):i((e=>{const t=document.createElement("div");return t.style="\n    z-index: 100;\n    position: fixed;\n    left: 0;\n    right: 0;\n    margin: 0 auto;\n    padding: 5px;\n    text-align: center;\n    background-color: #ff0000;\n    font-size: 18px;\n    font-weight: bold;",t.textContent=e,t})(e)),s)})(),window.load.get((e=>{window.renderPhotos(e),window.filters.show();const t=window.debounce((e=>window.renderPhotos(e)));window.filters.setHandler(t,e)}),(e=>{window.showPopup(e)})),window.form.setHandler((()=>{window.form.open(),window.form.uploadPhoto()}))})();
(()=>{"use strict";window.util={shuffle:function(e){let t,n;for(let o=e.length-1;o>0;o--)t=Math.floor(Math.random()*(o+1)),n=e[t],e[t]=e[o],e[o]=n;return e},modal:{show:function(e){e.classList.remove("hidden"),document.body.classList.add("modal-open")},hide:function(e){e.classList.add("hidden"),document.body.classList.remove("modal-open")}},element:{show:function(e){e.classList.remove("hidden")},hide:function(e){e.classList.add("hidden")}}},window.debounce=function(e){let t=null;return(...n)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...n)}),500)}},(()=>{const e=document.querySelector("#picture").content.querySelector(".picture");window.renderPicture=function(t){const n=e.cloneNode(!0);return n.querySelector(".picture__img").src=t.url,n.querySelector(".picture__likes").textContent=t.likes,n.querySelector(".picture__comments").textContent=t.comments.length,n}})(),(()=>{const e=document.querySelector(".big-picture"),t=e.querySelector(".big-picture__img img"),n=e.querySelector(".likes-count"),o=e.querySelector(".comments-count"),r=e.querySelector(".social__comments"),i=r.querySelector(".social__comment"),c=e.querySelector(".social__caption"),s=e.querySelector(".big-picture__cancel"),l=e.querySelector(".comments-loader");function u(e){const t=i.cloneNode(!0);return t.querySelector(".social__picture").src=e.avatar,t.querySelector(".social__picture").alt=e.name,t.querySelector(".social__text").textContent=e.message,t}function d(e){const t=document.createDocumentFragment();for(let n=0;n<e.length;n++)t.appendChild(u(e[n]));return r.appendChild(t)}function a(){v()}function m(e){"Escape"===e.key&&(e.preventDefault(),v())}function f(e){e.target.closest(".big-picture__preview")||v()}function v(){window.util.modal.hide(e),document.removeEventListener("keydown",m),e.removeEventListener("click",f),s.removeEventListener("click",a)}window.showBigPicture=function(i){window.util.modal.show(e),t.src=i.url,n.textContent=i.likes,o.textContent=i.comments.length,c.textContent=i.description,e.querySelector(".social__comment-count").classList.add("hidden"),function(e){r.innerHTML="";const t=e.length;let n=t>=5?5:t;function o(){const o=t-n,r=n+(o>=5?5:o);d(e.slice(n,r)),n=r,i()}function i(){t<=n?(window.util.element.hide(l),l.removeEventListener("click",o)):(window.util.element.show(l),l.addEventListener("click",o))}d(e.slice(0,n)),i()}(i.comments),document.addEventListener("keydown",m),e.addEventListener("click",f),s.addEventListener("click",a)}})(),(()=>{const e=document.querySelector(".img-upload__form"),t=e.querySelector(".img-upload__input"),n=document.querySelector(".img-upload__overlay"),o=n.querySelector(".img-upload__preview img"),r=n.querySelector(".img-upload__cancel"),i=n.querySelector(".img-upload__scale"),c=n.querySelector(".scale__control--smaller"),s=n.querySelector(".scale__control--value"),l=n.querySelector(".effects__list"),u={chrome:"grayscale",sepia:"sepia",marvin:"invert",phobos:"blur",heat:"brightness"},d=n.querySelector(".img-upload__effect-level"),a=d.querySelector(".effect-level__line"),m=d.querySelector(".effect-level__pin"),f=d.querySelector(".effect-level__value"),v=d.querySelector(".effect-level__depth"),w=n.querySelector(".text__hashtags"),p=/^#[a-zA-Zа-яА-Я\d]+$/,y=n.querySelector(".text__description");function h(){t.value="",o.style.transform="",l.querySelector("#effect-none").checked=!0,v.style.width="",w.value="",y.value="",window.util.modal.hide(n),k(S()),document.removeEventListener("keydown",L),r.removeEventListener("click",_),i.removeEventListener("click",E),l.removeEventListener("change",q),m.removeEventListener("mousedown",b),w.removeEventListener("input",C),y.removeEventListener("focusin",T),y.removeEventListener("focusout",V),w.removeEventListener("focusin",T),w.removeEventListener("focusout",V),e.removeEventListener("submit",g)}function _(){h()}function L(e){"Escape"===e.key&&(e.preventDefault(),h())}function g(t){window.load.post(new FormData(e),(()=>{h(),window.popup("success")}),(()=>{h(),window.popup("error")})),t.preventDefault()}function E(e){const t=parseInt(s.value,10);let n;var r,i;n=e.target===c?(r=t)>25?r-25:r:function(e){return 100===e?e:e+25}(t),s.value=n+"%",i=n,o.style.transform=`scale(${i/100})`}function q(e){e.target.matches('input[type="radio"]')&&(x(e.target.value,100),m.style.left=Math.floor(100*a.offsetWidth/100)+"px")}function k(e){o.classList.remove(e),o.style.filter="",v.style.width="100%"}function S(){const e=o.classList;for(let t=0;t<e.length;t++)if(e[t].includes("effects__preview--"))return e[t];return null}function b(e){e.preventDefault();const t=a.offsetWidth;let n=e.clientX;function o(e){e.preventDefault();let o=(r=m.offsetLeft,Math.floor(100*r/a.offsetWidth));var r;f.value=o,x(l.querySelector('input[type="radio"]:checked').value,o);const i=n-e.clientX;n=e.clientX;let c=m.offsetLeft-i;var s;s=c>0&&c<t?c:c>0?t:0,m.style.left=s+"px",v.style.width=o+"%"}document.addEventListener("mousemove",o),document.addEventListener("mouseup",(function e(t){t.preventDefault(),document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",e)}))}function x(e,t){switch(function(e){const t=S();var n;t!=="effects__preview--"+e&&("none"!==e?(window.util.element.show(d),k(t),n=e,o.classList.add("effects__preview--"+n)):(window.util.element.hide(d),k(t)))}(e),e){case"phobos":o.style.filter=u[e]+`(${3*t/100}px)`;break;case"heat":o.style.filter=u[e]+`(${3*t/100})`;break;case"marvin":o.style.filter=u[e]+`(${t}%)`;break;default:o.style.filter=u[e]+`(${t/100})`}}function C(e){!function(e){let t=e.target.value.split(/ +/);for(let e=0;e<t.length;e++)p.test(t[e])||0===t[e].length?t[e].length>20?(w.setCustomValidity(`Хэштэг ${t[e]} слишком длинный!`),$(w)):t.length>5?(w.setCustomValidity("Слишком много хэштэгов!"),$(w)):D(t)?(w.setCustomValidity("Не используйте одинаковые хэштэги!"),$(w)):P(t)?(w.setCustomValidity("Не используйте пустые хэштэги!"),$(w)):(w.setCustomValidity(""),w.style.border="",w.style.padding=""):(w.setCustomValidity(`Неверный формат хэштэга ${t[e]} !`),$(w)),w.reportValidity();w.reportValidity()}(e)}function D(e){return e.some((t=>e.indexOf(t)!==e.lastIndexOf(t)))}function $(e){e.style.border="5px solid red",e.style.padding="2px 7px"}function P(e){for(let t=0;t<e.length;t++)if(1===e[t].length)return!0;return!1}function T(){document.removeEventListener("keydown",L)}function V(){document.addEventListener("keydown",L)}y.maxLength=140,window.form={setHandler:function(e){t.addEventListener("change",e)},open:function(){window.util.modal.show(n),null===S()&&window.util.element.hide(d),s.value="100%",i.addEventListener("click",E),r.addEventListener("click",_),document.addEventListener("keydown",L),l.addEventListener("change",q),m.addEventListener("mousedown",b),w.addEventListener("input",C),y.addEventListener("focusin",T),y.addEventListener("focusout",V),w.addEventListener("focusin",T),w.addEventListener("focusout",V),e.addEventListener("submit",g)},close:h}})(),(()=>{const e="https://21.javascript.pages.academy/kekstagram";window.load={get:function(t,n){const o=new XMLHttpRequest;o.responseType="json",o.timeout=1e4,o.open("GET",e+"/data",!0),o.addEventListener("load",(function(){switch(o.status){case 200:t(o.response);break;case 400:n("Неверный запрос");break;case 401:n("Пользователь не авторизован");break;case 404:n("Ошибка загрузки данных");break;default:n("Cтатус ответа:"+(o.status+o.statusText))}})),o.addEventListener("error",(()=>{n("Произошла ошибка соединения")})),o.addEventListener("timeout",(()=>{n(`Запрос не успел выполниться за ${o.timeout/1e3} сек.`)})),o.send()},post:function(t,n,o){const r=new XMLHttpRequest;r.responseType="json",r.addEventListener("load",(function(){200===r.status?n():o()})),r.open("POST",e,!0),r.send(t)}}})(),(()=>{const e=document.querySelector(".img-filters");let t;window.filters={show:function(){e.classList.remove("img-filters--inactive")},get:function(e){const n=t.id,o=e.slice();switch(n){case"filter-random":return window.util.shuffle(o).slice(-10);case"filter-discussed":return o.sort(((e,t)=>t.comments.length-e.comments.length));default:return e}},changeButton:function(n){const o="img-filters__button--active";t=e.querySelector("."+o),t.classList.remove(o),n.classList.add(o),t=n}}})(),(()=>{const e=document.querySelector(".pictures");window.renderPhotos=function(t){const n=e.querySelectorAll(".picture");for(let e of n)e.parentNode.removeChild(e);const o=document.createDocumentFragment();for(let e=0;e<t.length;e++){let n=window.renderPicture(t[e],e);n.addEventListener("click",(()=>{window.showBigPicture(t[e])})),o.appendChild(n)}return e.appendChild(o)}})(),(()=>{const e=document.querySelector("main"),t=document.querySelector("#success").content.querySelector(".success").cloneNode(!0),n=t.querySelector(".success__button"),o=document.querySelector("#error").content.querySelector(".error").cloneNode(!0),r=o.querySelector(".error__button");let i;function c(t){e.insertAdjacentElement("afterbegin",t)}function s(e){e.remove(),e===t?(n.removeEventListener("click",l),document.removeEventListener("keydown",d),e.removeEventListener("click",a)):(r.removeEventListener("click",u),document.removeEventListener("keydown",d),e.removeEventListener("click",m))}function l(){s(t)}function u(){s(o)}function d(e){"Escape"===e.key&&(e.preventDefault(),s(i))}function a(e){e.target.closest(".success__inner")||s(t)}function m(e){e.target.closest(".error__inner")||s(o)}window.popup=function(e){return"success"===e?(i=t,c(i),n.addEventListener("click",l),document.addEventListener("keydown",d),i.addEventListener("click",a)):"error"===e?(i=o,c(i),r.addEventListener("click",u),document.addEventListener("keydown",d),i.addEventListener("click",m)):c(function(e){const t=document.createElement("div");return t.style="\n    z-index: 100;\n    position: fixed;\n    left: 0;\n    right: 0;\n    margin: 0 auto;\n    padding: 5px;\n    text-align: center;\n    background-color: #ff0000;\n    font-size: 18px;\n    font-weight: bold;",t.textContent=e,t}(e)),i}})(),(()=>{const e=document.querySelector(".img-filters__form");let t=[];window.load.get((function(n){t=n,window.renderPhotos(t),window.filters.show();const o=window.debounce((e=>window.renderPhotos(e)));e.addEventListener("click",(e=>{window.filters.changeButton(e.target);const n=window.filters.get(t);o(n)}))}),(function(e){window.popup(e)})),window.form.setHandler((function(){window.form.open()}))})()})();